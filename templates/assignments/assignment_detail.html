{% extends "base.html" %}
{% block title %}{{ assignment.title }} Â· Steadfast Scholars{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">{{ assignment.title }}</h4>
          {% if assignment.is_overdue %}
            <span class="badge bg-danger">Overdue</span>
          {% elif assignment.status == "complete" %}
            <span class="badge bg-success">Complete</span>
          {% elif assignment.status == "submitted" %}
            <span class="badge bg-info">Submitted</span>
          {% elif assignment.status == "in_progress" %}
            <span class="badge bg-primary">In Progress</span>
          {% else %}
            <span class="badge bg-secondary">Pending</span>
          {% endif %}
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3">Child</dt>
            <dd class="col-sm-9">
              <a href="{% url 'students:student_detail' assignment.child.pk %}">{{ assignment.child }}</a>
            </dd>

            <dt class="col-sm-3">Curriculum</dt>
            <dd class="col-sm-9">
              <a href="{% url 'curricula:curriculum_detail' assignment.curriculum.pk %}">{{ assignment.curriculum.name }}</a>
            </dd>

            <dt class="col-sm-3">Due Date</dt>
            <dd class="col-sm-9">
              {{ assignment.due_date|date:"M d, Y" }}
              {% if assignment.is_overdue %}
                <span class="text-danger fw-bold">(Overdue)</span>
              {% endif %}
            </dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">{{ assignment.get_status_display }}</dd>

            {% if assignment.description %}
              <dt class="col-sm-3">Description</dt>
              <dd class="col-sm-9">{{ assignment.description|linebreaks }}</dd>
            {% endif %}

            <dt class="col-sm-3">Assigned by</dt>
            <dd class="col-sm-9">
              {% if assignment.source == "teacher" and assignment.created_by %}
                {{ assignment.created_by.get_full_name|default:assignment.created_by.username }} (Teacher)
              {% elif assignment.source == "teacher" %}
                Teacher
              {% else %}
                Parent
              {% endif %}
            </dd>

            <dt class="col-sm-3">Created</dt>
            <dd class="col-sm-9">{{ assignment.created_at|date:"M d, Y" }}</dd>

            <dt class="col-sm-3">Last Updated</dt>
            <dd class="col-sm-9">{{ assignment.updated_at|date:"M d, Y" }}</dd>
          </dl>

          <hr>

          {% if can_edit %}
          <div class="mb-3">
            <h6>Student Update Link</h6>
            <p class="text-muted small">Share this link with your child so they can update the assignment status. Link expires in 7 days.</p>
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" id="studentLink" value="{{ request.scheme }}://{{ request.get_host }}{{ assignment.get_student_status_url }}" readonly>
              <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyStudentLink()">Copy</button>
            </div>
          </div>
          {% endif %}

          <hr>

          <div class="mb-3">
            <h6>Assessments</h6>
            {% if assessment_links %}
              {% for link in assessment_links %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">Take Test: {{ link.display_label }}</a>
                    {% if link.window_display %}
                      <span class="text-muted small ms-2">{{ link.window_display }}</span>
                    {% endif %}
                  </div>
                  {% if can_edit %}
                  <form method="post" action="{% url 'assignments:resource_link_delete' link.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove">&times;</button>
                  </form>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted small">No assessments added yet.</p>
            {% endif %}
          </div>

          <div class="mb-3">
            <h6>Resources</h6>
            {% if resource_links %}
              {% for link in resource_links %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer">{{ link.display_label }}</a>
                  {% if can_edit %}
                  <form method="post" action="{% url 'assignments:resource_link_delete' link.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove">&times;</button>
                  </form>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted small">No resources added yet.</p>
            {% endif %}
          </div>

          {% if can_edit %}
          <hr>
          <h6>Add Link</h6>
          <form method="post" action="{% url 'assignments:resource_link_add' assignment.pk %}">
            {% csrf_token %}
            <div class="row g-2 mb-2">
              <div class="col-md-3">
                <label for="id_link_type" class="form-label small">Type</label>
                <select name="link_type" id="id_link_type" class="form-select form-select-sm">
                  <option value="resource">Resource</option>
                  <option value="assessment">Assessment</option>
                </select>
              </div>
              <div class="col-md-5">
                <label for="id_label" class="form-label small">Label</label>
                <input type="text" name="label" class="form-control form-control-sm" id="id_label" maxlength="200" placeholder="e.g. CAASPP Practice Test" required>
              </div>
              <div class="col-md-4">
                <label for="id_url" class="form-label small">URL</label>
                <input type="url" name="url" class="form-control form-control-sm" id="id_url" placeholder="https://..." required>
              </div>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label for="id_window_start" class="form-label small">Window start</label>
                <input type="date" name="window_start" class="form-control form-control-sm" id="id_window_start">
              </div>
              <div class="col-md-3">
                <label for="id_window_end" class="form-label small">Window end</label>
                <input type="date" name="window_end" class="form-control form-control-sm" id="id_window_end">
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">Add</button>
              </div>
            </div>
          </form>
          {% endif %}
        </div>
        <div class="card-footer">
          <a href="{% url 'assignments:assignment_list' %}" class="btn btn-secondary">Back to List</a>
          {% if can_edit %}
          <a href="{% url 'assignments:assignment_update' assignment.pk %}" class="btn btn-primary">Edit</a>
          {% endif %}
          {% if can_delete %}
          <a href="{% url 'assignments:assignment_delete' assignment.pk %}" class="btn btn-danger">Delete</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyStudentLink() {
  var linkInput = document.getElementById('studentLink');
  linkInput.select();
  linkInput.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(linkInput.value);
}
</script>
{% endblock %}
